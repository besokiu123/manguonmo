<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Giỏ hàng</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <header class="site-header"><div class="container nav-row"><div class="logo">Pawsome</div><nav class="nav"><a href="index.html">Trang chủ</a></nav></div></header>
    <main class="container">
      <h2>Giỏ hàng</h2>
      <div id="root">Đang tải...</div>
      <hr />
      <h3>Thanh toán</h3>
      <form id="checkout">
        <div><label>Tên:<br/><input name="name" required></label></div>
        <div><label>Điện thoại:<br/><input name="phone" required></label></div>
        <div><label>Địa chỉ:<br/><textarea name="address" required></textarea></label></div>
        <div style="margin-top:8px"><button class="btn-primary" type="submit">Đặt hàng</button></div>
      </form>
    </main>

    <script>
      async function loadCart(){ const res = await fetch('/backend/api/cart.php'); if(!res.ok){document.getElementById('root').innerText='Lỗi';return} const d = await res.json(); render(d); }
      function render(d){ const root=document.getElementById('root'); if(!d||!d.items||d.items.length===0){root.innerHTML='<div class="cart-empty">Giỏ hàng trống</div>'; return;} root.innerHTML = '<table style="width:100%"><thead><tr><th></th><th>Sản phẩm</th><th>SL</th><th>Thành tiền</th><th></th></tr></thead><tbody>'+ d.items.map(i=>`<tr><td><img src="${i.image}" style="width:64px;height:64px;object-fit:cover;border-radius:6px"/></td><td>${i.name}</td><td>${i.qty}</td><td>₫${i.subtotal.toLocaleString('vi-VN')}</td><td><button class="btn-outline remove" data-id="${i.id}">Xóa</button></td></tr>`).join('') + '</tbody></table><div style="text-align:right;font-weight:700;margin-top:8px">Tổng: ₫'+d.total.toLocaleString('vi-VN')+'</div>'; document.querySelectorAll('.remove').forEach(b=>b.addEventListener('click', async ()=>{ const id=b.getAttribute('data-id'); await fetch('/backend/api/cart.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'remove',id:parseInt(id)})}); loadCart(); })); }

      document.getElementById('checkout').addEventListener('submit', async function(e){ e.preventDefault(); const f=new FormData(e.target); const customer = {name:f.get('name'), phone:f.get('phone'), address:f.get('address')}; const res = await fetch('/backend/api/order.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customer})}); if(!res.ok){alert('Lỗi server');return} const j=await res.json(); if(j.success){ alert('Đặt hàng thành công. Mã: '+j.order.id); loadCart(); e.target.reset(); } else alert('Lỗi: '+j.message); });

      loadCart();
    </script>
  </body>
</html>
